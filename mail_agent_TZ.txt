ТЕХНИЧЕСКОЕ ЗАДАНИЕ

ПОЧТОВЫЙ ИИ-АГЕНТ ДЛЯ CURSOR → GITHUB → RAILWAY

=================================================

ЦЕЛЬ

----

Создать Python-проект "mail-agent", который:

1. Подключается к 1–2 почтовым ящикам (Gmail или Custom IMAP/SMTP).

2. Каждую минуту проверяет почту.

3. Выжимает суть письма через OpenAI.

4. Присылает уведомления в Telegram-бот.

5. Позволяет отвечать на письма прямо из Telegram.

6. Настройка почты полностью через Telegram (провайдер, логин, пароль).

7. Работает 24/7 как сервис на Railway (тип — Worker).

8. Исходный код хранится в GitHub.

----------------------------------------------------

СТЕК

----------------------------------------------------

Язык:

- Python 3.11+

Библиотеки:

- aiogram==2.25.1

- openai>=1.51.0

- python-dotenv>=1.0.0

- стандартная библиотека (imaplib, smtplib, email, json, asyncio)

Хостинг:

- Railway (Worker service)

CI/CD:

- GitHub repository → Deploy to Railway

IDE:

- Cursor

----------------------------------------------------

СТРУКТУРА РЕПОЗИТОРИЯ

----------------------------------------------------

mail-agent/

  ├─ app/

  │   ├─ __init__.py

  │   ├─ main.py            # точка входа

  │   ├─ ai_client.py       # работа с OpenAI

  │   ├─ email_client.py    # IMAP/SMTP

  │   ├─ telegram_bot.py    # Telegram логика

  │   ├─ storage.py         # сохранение почтовых аккаунтов

  ├─ requirements.txt

  ├─ README.md

  ├─ .gitignore

  └─ email_accounts.json    # создаётся ботом (НЕ КОММИТИТЬ)

.gitignore должен включать:

__pycache__/

*.pyc

email_accounts.json

.env

----------------------------------------------------

ПЕРЕМЕННЫЕ ОКРУЖЕНИЯ (ENV)

----------------------------------------------------

Все задаются в Railway → Variables:

- TELEGRAM_BOT_TOKEN

- OWNER_TELEGRAM_ID   (int)

- OPENAI_API_KEY

Почтовые логины/пароли НЕ в ENV — только через Telegram.

----------------------------------------------------

ЛОГИКА ПРОЕКТА

----------------------------------------------------

=========================

1. Telegram-бот

=========================

Команда `/start`:

- проверяет, что message.from_user.id == OWNER_TELEGRAM_ID

- выводит клавиатуру:

  - Аккаунт 1 — Gmail

  - Аккаунт 1 — Другая почта

  - Аккаунт 2 — Gmail

  - Аккаунт 2 — Другая почта

Callback data:

- setup:<account_id>:gmail

- setup:<account_id>:custom

Пошаговый wizard настройки:

Для Gmail:

  step= gmail_user:

      - спросить email

  step= gmail_pass:

      - спросить пароль (app password)

  Автоматически подставить:

      imap_host = "imap.gmail.com"

      smtp_host = "smtp.gmail.com"

      smtp_port = 587

Для Custom:

  step= imap_host → imap_user → imap_pass → smtp_host → smtp_port

Все данные сохраняются в email_accounts.json через storage.save_accounts().

Гарантии:

- если пользователь вводит некорректный порт → просим повторить

- если IMAP/SMTP ошибка — объяснить про необходимость app password

Команда `/reply <ID> <текст>`:

- Находит письмо в EMAIL_CACHE

- Вызывает AI → polish_reply

- Отправляет через SMTP

- Сообщает об успехе или ошибке

=========================

2. OpenAI слой

=========================

Функция `summarize_email(text) -> str`:

- модель: gpt-4.1-mini

- системный промпт: "сделай резюме письма (1–3 предложения)"

- возвращает краткое резюме

Функция `polish_reply(draft, context) -> str`:

- принимает текст черновика (рус/англ)

- добавляет контекст письма

- возвращает деловой английский ответ

=========================

3. Email слой

=========================

IMAP (получение писем):

- Функция check_account_emails(account_id: int):

  - берет настройки аккаунта:

      imap_host

      imap_user

      imap_pass

  - пытается login() → если ошибка IMAP4.error:

      → отправить в Telegram:

        "возможно включена двухфакторная аутентификация, нужен app password"

  - ищет письма UNSEEN

  - парсит From, Subject, Date, Body

  - вызывает summarize_email(body)

  - создаёт local_id: f"{account_id}-{timestamp_ms}"

  - сохраняет письмо в EMAIL_CACHE

  - отправляет в Telegram сообщение о новом письме

SMTP (отправка):

- send_email_smtp(account_id, to, subject, body)

- при SMTPAuthenticationError

  → Telegram: "вероятно включена 2FA, нужен app password"

=========================

4. Scheduler

=========================

В main():

- load_accounts()

- создать background-задачу email_checker_loop()

- loop:

      check_account_emails(1)

      check_account_emails(2)

      sleep(CHECK_INTERVAL)

=========================

5. Storage

=========================

email_accounts.json хранит:

{

  "1": {

    "imap_host": "...",

    "imap_user": "...",

    "imap_pass": "...",

    "smtp_host": "...",

    "smtp_port": 587

  },

  "2": {...}

}

storage.py:

- load_accounts()

- save_accounts()

- get_account(account_id)

----------------------------------------------------

ТЕСТИРОВАНИЕ

----------------------------------------------------

1. Запуск локально:

   export TELEGRAM_BOT_TOKEN=...

   export OWNER_TELEGRAM_ID=...

   export OPENAI_API_KEY=...

   python -m app.main

2. Написать боту в Telegram → /start

3. Настроить аккаунт Gmail (email → app password)

4. Отправить письмо на этот адрес → проверить резюме

5. Ответить командой:

   /reply <ID> отвечаю что давайте созвонимся

6. Проверить отправку в реальной почте

----------------------------------------------------

РАЗВЁРТЫВАНИЕ НА RAILWAY

----------------------------------------------------

1. Создать GitHub репозиторий:

   git init

   git add .

   git commit -m "initial"

   git branch -M main

   git remote add origin <repo>

   git push -u origin main

2. В Railway:

   - New Project → Deploy from GitHub → mail-agent

   - Тип → Worker (не веб)

   - Variables:

       TELEGRAM_BOT_TOKEN

       OWNER_TELEGRAM_ID

       OPENAI_API_KEY

   - Start Command:

       python -m app.main

3. Railway автоматически будет держать бота онлайн 24/7.

----------------------------------------------------

ГОТОВО.  

По этому ТЗ Cursor должен:  

- создать проект,  

- собрать код,  

- подготовить requirements.txt,  

- обновить README,  

- готовить push в GitHub,  

- проект полностью готов для деплоя на Railway.

----------------------------------------------------

